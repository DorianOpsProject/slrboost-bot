<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>SLR BOOST ‚Äî Mini App</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            bg0: '#05070D',
            bg1: '#0B1020',
            glass: 'rgba(255,255,255,.06)',
            glass2: 'rgba(255,255,255,.09)',
            stroke: 'rgba(255,255,255,.10)',
            stroke2: 'rgba(255,255,255,.16)',
            text: 'rgba(250,253,255,.96)',
            muted: 'rgba(250,253,255,.66)',
            muted2: 'rgba(250,253,255,.48)',
            accent: '#FFD400',
            accent2: '#FFB800',
            good: '#2EE59D',
            bad: '#FF4D4D',
            ink: 'rgba(12,16,26,.88)'
          },
          boxShadow: {
            soft: '0 10px 26px rgba(0,0,0,.42)',
            deep: '0 18px 60px rgba(0,0,0,.55)',
            accent: '0 18px 34px rgba(255,212,0,.14)',
            neon: '0 0 0 1px rgba(255,255,255,.06), 0 22px 70px rgba(0,0,0,.55)'
          },
          borderRadius: {
            xl2: '18px',
            xl3: '24px',
            xl4: '28px',
          },
          keyframes: {
            floaty: { '0%,100%': { transform: 'translate3d(0,0,0) scale(1)' }, '50%': { transform: 'translate3d(0,26px,0) scale(1.06)' } },
            floaty2:{ '0%,100%': { transform: 'translate3d(0,0,0) scale(1)' }, '50%': { transform: 'translate3d(0,18px,0) scale(1.05)' } },
            floaty3:{ '0%,100%': { transform: 'translate3d(0,0,0) scale(1)' }, '50%': { transform: 'translate3d(0,30px,0) scale(1.06)' } },
            sheen: { 'to': { transform: 'rotate(360deg)' } },
            drift: { '0%,100%': { transform: 'translate3d(0,0,0) scale(1)' }, '50%': { transform: 'translate3d(12px,12px,0) scale(1.03)' } },
            sweep: { '0%': { transform:'translateX(-65%)' }, '50%': { transform:'translateX(65%)' }, '100%': { transform:'translateX(-65%)' } },
            pop: { '0%':{ transform:'scale(.96)' }, '100%':{ transform:'scale(1)' } }
          },
          animation: {
            floaty: 'floaty 14s ease-in-out infinite',
            floaty2:'floaty2 17s ease-in-out infinite',
            floaty3:'floaty3 19s ease-in-out infinite',
            sheen: 'sheen 2.8s linear infinite',
            drift: 'drift 11s ease-in-out infinite',
            sweep: 'sweep 5.8s ease-in-out infinite',
            pop: 'pop .18s ease-out'
          },
          fontFamily: {
            ui: ['ui-sans-serif','system-ui','-apple-system','"SF Pro Display"','"SF Pro Text"','Segoe UI','Roboto','Helvetica','Arial','"Apple Color Emoji"','"Segoe UI Emoji"']
          }
        }
      }
    }
  </script>
</head>

<body
  class="min-h-screen overflow-x-hidden font-ui text-text
         [--safe-top:env(safe-area-inset-top)] [--safe-bottom:env(safe-area-inset-bottom)]
         bg-[radial-gradient(1200px_800px_at_15%_0%,rgba(255,212,0,.14),transparent_60%),radial-gradient(900px_600px_at_85%_20%,rgba(46,229,157,.10),transparent_55%),radial-gradient(900px_700px_at_50%_110%,rgba(105,140,255,.10),transparent_60%),linear-gradient(180deg,#05070D,#0B1020)]
         motion-reduce:[&_*]:!transition-none motion-reduce:[&_*]:!animate-none motion-reduce:scroll-auto">

  <!-- FX orbs -->
  <div class="pointer-events-none fixed inset-0 z-0 overflow-hidden opacity-95" aria-hidden="true">
    <div class="absolute -left-[180px] -top-[220px] h-[560px] w-[560px] rounded-full blur-[40px] opacity-[.16] animate-floaty
                bg-[radial-gradient(circle_at_35%_30%,rgba(255,212,0,.95),rgba(255,212,0,0)_62%)]"></div>

    <div class="absolute -right-[240px] top-[60px] h-[560px] w-[560px] rounded-full blur-[40px] opacity-[.16] animate-floaty2
                bg-[radial-gradient(circle_at_40%_35%,rgba(46,229,157,.95),rgba(46,229,157,0)_62%)]"></div>

    <div class="absolute left-[22%] -bottom-[360px] h-[560px] w-[560px] rounded-full blur-[40px] opacity-[.16] animate-floaty3
                bg-[radial-gradient(circle_at_50%_40%,rgba(105,140,255,.95),rgba(105,140,255,0)_62%)]"></div>
  </div>

  <div class="relative z-10 mx-auto max-w-[980px] px-[14px] pb-[calc(104px+var(--safe-bottom))] pt-[calc(14px+var(--safe-top))]">
    <!-- TOPBAR -->
    <header class="sticky top-0 z-20 -mx-[14px] mb-3 border-b border-white/5 bg-gradient-to-b from-[#05070D]/92 to-[#05070D]/55 px-[14px] pb-3 pt-[calc(14px+var(--safe-top))] backdrop-blur-[16px]">
      <div class="flex items-center justify-between gap-3">
        <div class="flex min-w-0 items-center gap-3">
          <div class="relative flex h-[46px] w-[46px] flex-none items-center justify-center overflow-hidden rounded-[16px] text-[#101010] shadow-[0_16px_30px_rgba(255,212,0,.16)]
                      bg-gradient-to-br from-accent to-accent2">
            <div class="absolute inset-[-40%] opacity-60 animate-sheen
                        bg-[conic-gradient(from_180deg,rgba(255,255,255,0),rgba(255,255,255,.55),rgba(255,255,255,0))]"></div>
            <span class="relative text-[18px] font-black">‚ö°</span>
          </div>
          <div class="min-w-0">
            <h1 class="truncate text-[18px] font-black tracking-[.2px]">SLR BOOST</h1>
            <p class="truncate text-[12.5px] text-muted">Catalogue premium ‚Ä¢ Commande ta frappe en priv√©</p>
          </div>
        </div>

        <div class="flex flex-none items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-2 shadow-soft">
          <span class="h-2.5 w-2.5 rounded-full bg-good shadow-[0_0_0_3px_rgba(46,229,157,.10)]"></span>
          <span class="text-[12px] tracking-[.2px] text-muted">OUVERT</span>
        </div>
      </div>

      <!-- Search + cart icon -->
      <div class="mt-3 flex items-center gap-2.5">
        <div class="flex flex-1 items-center gap-2.5 rounded-xl2 border border-white/10 bg-white/5 px-3.5 py-3 shadow-soft">
          <svg class="opacity-80" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18.5a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="2" opacity=".9"/>
            <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".9"/>
          </svg>
          <input id="q" class="w-full bg-transparent text-[14px] text-text outline-none placeholder:text-white/45"
                 type="search" placeholder="Recherche : produit, r√©f√©rence, tag‚Ä¶" autocomplete="off"/>
        </div>

        <button id="btnCartTop" type="button"
                class="grid h-[46px] w-[46px] flex-none place-items-center rounded-[16px] border border-white/10 bg-white/5 text-white/90 shadow-soft transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10"
                aria-label="Ouvrir le panier">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6h15l-1.7 8.5a2 2 0 01-2 1.5H9.2a2 2 0 01-2-1.6L6 6z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M6 6l-2-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="9.5" cy="20" r="1.5" fill="currentColor"/>
            <circle cx="17.5" cy="20" r="1.5" fill="currentColor"/>
          </svg>
        </button>
      </div>

      <!-- Chips -->
      <div id="chipsRow" class="mt-3 flex items-center gap-2.5 overflow-x-auto pb-0.5 [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden"></div>
    </header>

    <!-- HERO -->
    <section
      class="relative mb-3 overflow-hidden rounded-xl4 border border-white/10 bg-white/5 p-4 shadow-neon
             before:content-[''] before:absolute before:inset-0 before:pointer-events-none before:opacity-[.08] before:mix-blend-overlay
             before:bg-[url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.25'/%3E%3C/svg%3E&quot;)]">
      <div class="pointer-events-none absolute inset-[-1px] opacity-70">
        <div class="absolute inset-[-40%] blur-[28px] opacity-70 animate-drift
                    bg-[radial-gradient(circle_at_22%_20%,rgba(255,212,0,.22),transparent_58%),radial-gradient(circle_at_80%_25%,rgba(46,229,157,.14),transparent_60%),radial-gradient(circle_at_55%_110%,rgba(105,140,255,.12),transparent_62%)]"></div>
        <div class="absolute inset-[-1px] opacity-60 animate-sweep
                    bg-[linear-gradient(90deg,transparent,rgba(255,255,255,.10),transparent)]"></div>
      </div>

      <div class="relative flex flex-col gap-3">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="inline-flex items-center gap-2 rounded-full border border-[rgba(255,212,0,.20)] bg-[rgba(255,212,0,.08)] px-3 py-1.5 text-[12px] text-[rgba(255,247,215,.92)]">
              <span class="font-black text-accent">EXCLU</span> ‚Ä¢ Catalogue priv√©
            </div>
            <h2 class="mt-2 text-[18px] font-black tracking-[.2px]">Un nouveau syst√®me de vente exclusif.</h2>
            <p class="mt-1 text-[12.8px] leading-snug text-muted">
              S√©lection premium ‚Ä¢ Panier propre ‚Ä¢ Commande envoy√©e en priv√©.
            </p>
          </div>

          <div class="hidden sm:flex flex-col items-end gap-2">
            <div class="rounded-full border border-white/10 bg-white/5 px-3 py-2 text-[12px] text-muted shadow-soft">
              Livraison <span class="font-black text-white/90">59 / 62 / Belgium</span>
            </div>
            <div class="rounded-full border border-white/10 bg-white/5 px-3 py-2 text-[12px] text-muted shadow-soft">
              Paiement / prix <span class="font-black text-white/90">confirm√©s en PV</span>
            </div>
          </div>
        </div>

        <div class="grid gap-2 sm:grid-cols-3">
          <div class="rounded-xl3 border border-white/10 bg-black/20 p-3">
            <div class="text-[12px] text-muted2">Qualit√©</div>
            <div class="mt-0.5 text-[13px] font-black">Premium uniquement</div>
          </div>
          <div class="rounded-xl3 border border-white/10 bg-black/20 p-3">
            <div class="text-[12px] text-muted2">Discr√©tion</div>
            <div class="mt-0.5 text-[13px] font-black">Commande en priv√©</div>
          </div>
          <div class="rounded-xl3 border border-white/10 bg-black/20 p-3">
            <div class="text-[12px] text-muted2">Rapidit√©</div>
            <div class="mt-0.5 text-[13px] font-black">R√©cap auto + envoi</div>
          </div>
        </div>
      </div>
    </section>

    <!-- LIST -->
    <main>
      <div class="mb-2 flex items-center justify-between">
        <div class="text-[13px] font-black tracking-[.2px] text-white/90">Catalogue</div>
        <div id="countInfo" class="text-[12px] text-muted">‚Äî</div>
      </div>

      <div id="list" class="flex flex-col gap-3"></div>

      <div id="emptyState" class="hidden rounded-xl2 border border-dashed border-white/15 bg-white/5 p-4 text-center text-[13px] leading-snug text-muted">
        Aucun produit ne correspond √† ta recherche.
      </div>
    </main>
  </div>

  <!-- BOTTOM CART BAR -->
  <div class="fixed bottom-0 left-0 right-0 z-40 border-t border-white/5 bg-gradient-to-b from-[#05070D]/0 to-[#05070D]/90 px-[14px] pb-[calc(10px+var(--safe-bottom))] pt-2.5 backdrop-blur-[14px]">
    <div class="mx-auto flex max-w-[980px] items-center justify-between gap-2.5">
      <div id="cartPreview"
           class="flex flex-1 cursor-pointer items-center justify-between gap-3 rounded-xl4 border border-white/10 bg-white/5 p-3 shadow-soft transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10">
        <div class="min-w-0">
          <div class="flex items-center gap-2 font-black text-[13px]">üçÅ Panier</div>
          <div id="cartHint" class="truncate text-[12px] text-muted">Aucun article</div>
        </div>
        <div id="cartCountBadge"
             class="grid h-[34px] min-w-[34px] place-items-center rounded-full border border-[rgba(255,212,0,.22)] bg-[rgba(255,212,0,.16)] px-2 font-black text-[13px] text-[rgba(255,247,215,.95)]">
          0
        </div>
      </div>
    </div>
  </div>

  <!-- MASK + SHEET -->
  <div id="mask" class="fixed inset-0 z-[60] bg-black/60 opacity-0 pointer-events-none transition-opacity"></div>

  <aside id="sheet"
         class="fixed left-1/2 z-[61] w-[min(980px,calc(100%-18px))] -translate-x-1/2 rounded-[28px] border border-white/10 shadow-deep backdrop-blur-[18px]
                transition-[bottom] duration-300 [transition-timing-function:cubic-bezier(.2,.9,.2,1)]
                bg-[radial-gradient(900px_340px_at_20%_0%,rgba(255,212,0,.14),transparent_60%),radial-gradient(900px_340px_at_80%_0%,rgba(46,229,157,.10),transparent_62%),rgba(12,16,26,.88)]"
         style="bottom: calc(-100% - 40px);"
         role="dialog" aria-modal="true" aria-label="Panier et commande">

    <div class="px-3.5 pt-3">
      <div class="mx-auto h-1.5 w-11 rounded-full bg-white/20" aria-hidden="true"></div>
    </div>

    <div class="flex items-center justify-between gap-2.5 border-b border-white/10 px-3.5 py-3">
      <div class="text-[14px] font-black tracking-[.2px]">Panier & Commande</div>
      <button id="sheetClose" type="button"
              class="rounded-xl2 border border-white/10 bg-white/5 px-3 py-2 text-white/90 transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10">
        Fermer
      </button>
    </div>

    <div id="sheetBody" class="max-h-[min(64vh,580px)] overflow-auto px-3.5 pb-3.5 pt-3 scrollbar-thin scrollbar-thumb-white/10">
      <div class="rounded-xl4 border border-white/10 bg-white/5 p-3.5">
        <h3 class="mb-2.5 text-[13px] font-black tracking-[.2px] text-white/95">Produits s√©lectionn√©s</h3>
        <div id="cartItems"></div>
        <div id="cartEmpty" class="hidden rounded-xl2 border border-dashed border-white/15 bg-white/5 p-4 text-center text-[13px] leading-snug text-muted">
          Ton panier est vide.
        </div>
      </div>

      <div class="mt-3 rounded-xl4 border border-white/10 bg-white/5 p-3.5">
        <h3 class="mb-2.5 text-[13px] font-black tracking-[.2px] text-white/95">Livraison / Sur place</h3>

        <div class="grid grid-cols-1 gap-2.5 sm:grid-cols-2">
          <div class="flex flex-col gap-1.5">
            <label class="text-[12px] text-muted2" for="mode">Mode</label>
            <select id="mode" class="rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none">
              <option value="LIVRAISON">Livraison</option>
              <option value="SUR_PLACE">Sur place</option>
            </select>
          </div>

          <div class="flex flex-col gap-1.5">
            <label class="text-[12px] text-muted2" for="zone">Zone</label>
            <select id="zone" class="rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none">
              <option value="59">59</option>
              <option value="62">62</option>
              <option value="BELGIUM">BELGIUM</option>
              <option value="AUTRE">Autre</option>
            </select>
          </div>

          <div class="flex flex-col gap-1.5">
            <label class="text-[12px] text-muted2" for="fullname">Ton surnom</label>
            <input id="fullname" class="rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none"
                   type="text" placeholder="Ex: Alex D." autocomplete="name">
          </div>

          <div class="flex flex-col gap-1.5">
            <label class="text-[12px] text-muted2" for="phone">T√©l√©phone</label>
            <input id="phone" class="rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none"
                   type="tel" placeholder="Ex: 06 00 00 00 00" autocomplete="tel">
          </div>

          <div id="addrField" class="flex flex-col gap-1.5 sm:col-span-2">
            <label class="text-[12px] text-muted2" for="address">Adresse (si livraison)</label>
            <input id="address" class="rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none"
                   type="text" placeholder="Rue + num√©ro + ville" autocomplete="street-address">
          </div>

          <div class="flex flex-col gap-1.5 sm:col-span-2">
            <label class="text-[12px] text-muted2" for="note">Message (optionnel)</label>
            <textarea id="note" class="min-h-[82px] resize-y rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none"
                      placeholder="Infos utiles, cr√©neau, pr√©cision‚Ä¶"></textarea>
          </div>
        </div>

        <div class="mt-2.5 rounded-xl2 border border-[rgba(255,212,0,.18)] bg-[rgba(255,212,0,.08)] px-3 py-2.5 text-[12px] leading-snug text-[rgba(255,247,215,.92)]">
          ‚ö†Ô∏è Le total affich√© est indicatif. Le montant final peut varier (disponibilit√© / ajustements).
        </div>
      </div>
    </div>

    <div class="border-t border-white/10 bg-black/10 px-3.5 py-3.5">
      <div class="flex items-center justify-between text-[12px] text-muted">
        <span>Total indicatif</span>
        <b id="total" class="text-[16px] font-black text-white/95">0.00 ‚Ç¨</b>
      </div>

      <div class="mt-2.5 flex flex-wrap gap-2.5">
        <button id="clear" type="button"
                class="flex-1 rounded-xl2 border border-white/10 bg-white/5 px-4 py-3 font-black tracking-[.2px] text-white/90 shadow-soft transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10">
          Vider
        </button>
        <button id="copy" type="button"
                class="flex-1 rounded-xl2 border border-white/10 bg-white/5 px-4 py-3 font-black tracking-[.2px] text-white/90 shadow-soft transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10">
          Copier le r√©cap
        </button>
        <button id="order" type="button"
                class="flex-[2_1_220px] rounded-xl2 px-4 py-3 font-black tracking-[.2px] text-[#141414] shadow-accent transition active:translate-y-[1px] active:scale-[.99] hover:brightness-105 bg-gradient-to-br from-accent to-accent2">
          Commander
        </button>
      </div>
    </div>
  </aside>

  <!-- ‚úÖ MEDIA MODAL (NEW) -->
  <div id="mediaMask" class="fixed inset-0 z-[80] bg-black/70 opacity-0 pointer-events-none transition-opacity"></div>

  <aside id="mediaModal"
         class="fixed left-1/2 top-1/2 z-[81] w-[min(980px,calc(100%-18px))] -translate-x-1/2 -translate-y-1/2
                rounded-[28px] border border-white/10 bg-[rgba(12,16,26,.90)] shadow-deep backdrop-blur-[18px]
                opacity-0 pointer-events-none transition-all duration-200"
         role="dialog" aria-modal="true" aria-label="Voir le produit">

    <div class="flex items-center justify-between gap-3 border-b border-white/10 px-4 py-3">
      <div class="min-w-0">
        <div id="mediaTitle" class="truncate text-[14px] font-black tracking-[.2px]">Produit</div>
        <div id="mediaSub" class="truncate text-[12px] text-muted">‚Äî</div>
      </div>

      <button id="mediaClose" type="button"
              class="grid h-10 w-10 place-items-center rounded-xl2 border border-white/10 bg-white/5 text-white/90 transition active:scale-[.98] hover:border-white/15 hover:bg-white/10"
              aria-label="Fermer">
        ‚úï
      </button>
    </div>

    <div class="p-4">
      <div class="relative overflow-hidden rounded-xl4 border border-white/10 bg-black/30">
        <div id="mediaWrap" class="relative aspect-video w-full">
          <!-- injected -->
        </div>
      </div>

      <div class="mt-3 flex flex-wrap items-center justify-between gap-2">
        <div class="text-[12px] text-muted">
          Astuce: pinch/zoom sur image (si support√©) ‚Ä¢ vid√©o avec son si l‚Äôutilisateur active
        </div>
      </div>
    </div>
  </aside>

  <!-- TOAST -->
  <div id="toast"
       class="fixed left-1/2 z-[90] max-w-[min(92vw,620px)] -translate-x-1/2 rounded-full border border-white/15 bg-[rgba(12,16,26,.86)] px-3 py-2 text-[13px] text-white/90 opacity-0 pointer-events-none shadow-deep backdrop-blur-[14px] transition bottom-[calc(104px+var(--safe-bottom))]">
    OK
  </div>

  <script>
    /* ===========================
       DATA
       =========================== */
  const PRODUCTS = [
  {
    id:"SLR-P01",
    name:"Mousseux",
    category:"Catalogue",
    origin:"üá≤üá¶üç´",
    quality:"Premium",
    price:10.00,
    desc:"Description (exemple).",
    tags:["Nouveau"],
    media:{ type:"video", src:"https://raw.githubusercontent.com/DorianOpsProject/slrboost-bot/refs/heads/main/7674BB32-4909-49E2-8617-CD8F1A4447C5.mov" }
  },
  {
    id:"SLR-P02",
    name:"Static",
    category:"Catalogue",
    origin:"üá≤üá¶üç´",
    quality:"Premium",
    price:0.00,
    desc:"Description (exemple).",
    tags:["Populaire"],
    media:{ type:"video", src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" }
  },
  {
    id:"SLR-P03",
    name:"Frozen",
    category:"Catalogue",
    origin:"üá≤üá¶üç´",
    quality:"Premium",
    price:15.00,
    desc:"Description (exemple).",
    tags:["Stock limit√©"],
    media:{ type:"image", src:"https://images.unsplash.com/photo-1516455207990-7a41ce80f7ee?auto=format&fit=crop&w=1400&q=80" }
  },
  {
    id:"SLR-P04",
    name:"Beldia",
    category:"Catalogue",
    origin:"üá≤üá¶üç´",
    quality:"Premium",
    price:12.00,
    desc:"Description (exemple).",
    tags:[],
    media:{ type:"image", src:"https://images.unsplash.com/photo-1528826194825-0e5f49d6a52a?auto=format&fit=crop&w=1400&q=80" }
  },
  {
    id:"SLR-P05",
    name:"Produit 05",
    category:"Catalogue",
    origin:"üá≥üá±",
    quality:"Premium",
    price:0.00,
    desc:"Description (exemple).",
    tags:["Best-seller"],
    media:{ type:"video", src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm" }
  },
  {
    id:"SLR-P06",
    name:"Produit 06",
    category:"Catalogue",
    origin:"üá≥üá±",
    quality:"Premium",
    price:0.00,
    desc:"Description (exemple).",
    tags:[],
    media:{ type:"image", src:"https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&fit=crop&w=1400&q=80" }
  },
  {
    id:"SLR-P07",
    name:"Cali Plates",
    category:"Catalogue",
    origin:"üá∫üá∏",
    quality:"Premium",
    price:0.00,
    desc:"Description (exemple).",
    tags:["USA"],
    media:{ type:"video", src:"https://t.me/c/3265047661/52" }
  },
  {
    id:"SLR-P08",
    name:"Cali NL",
    category:"Catalogue",
    origin:"üá≥üá±",
    quality:"Premium",
    price:10.00,
    desc:"Description (exemple).",
    tags:[],
    media:{ type:"image", src:"https://images.unsplash.com/photo-1523275335684-37898b6baf30?auto=format&fit=crop&w=1400&q=80" }
  },
  {
    id:"SLR-P09",
    name:"Cali US",
    category:"Catalogue",
    origin:"üá∫üá∏",
    quality:"Premium",
    price:20.00,
    desc:"Description (exemple).",
    tags:[],
    media:{ type:"video", src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" }
  },
  {
    id:"SLR-P10",
    name:"Produit 10",
    category:"Catalogue",
    origin:"üá∫üá∏",
    quality:"Premium",
    price:0.00,
    desc:"Description (exemple).",
    tags:[],
    media:{ type:"image", src:"https://images.unsplash.com/photo-1526170375885-4d8ecf77b99f?auto=format&fit=crop&w=1400&q=80" }
  },
  {
    id:"SLR-P11",
    name:"Cali Canadienne",
    category:"Catalogue",
    origin:"üá®üá¶",
    quality:"Premium",
    price:12.00,
    desc:"Description (exemple).",
    tags:["Canada"],
    media:{ type:"image", src:"https://images.unsplash.com/photo-1520975958225-7a5dfb0b7e5d?auto=format&fit=crop&w=1400&q=80" }
  }
];

    const CONTACT_USERNAME = "Petter59000XSLR";
    const CART_KEY = "slr_cart_tw_v2";
    const FORM_KEY = "slr_form_tw_v2";

    /* ===========================
       TELEGRAM INIT
       =========================== */
    const tg = window.Telegram?.WebApp;
    try{
      tg?.ready?.();
      tg?.expand?.();
      tg?.setHeaderColor?.("#05070D");
      tg?.setBackgroundColor?.("#05070D");
    }catch(e){}

    /* ===========================
       STATE
       =========================== */
    const state = {
      q: "",
      filter: "ALL",
      cart: loadJSON(CART_KEY, {}),
      form: loadJSON(FORM_KEY, {
        mode: "LIVRAISON",
        zone: "59",
        fullname: "",
        phone: "",
        address: "",
        note: ""
      })
    };

    /* ===========================
       DOM
       =========================== */
    const el = {
      q: document.getElementById("q"),
      chipsRow: document.getElementById("chipsRow"),
      list: document.getElementById("list"),
      empty: document.getElementById("emptyState"),
      countInfo: document.getElementById("countInfo"),

      cartPreview: document.getElementById("cartPreview"),
      cartHint: document.getElementById("cartHint"),
      cartCountBadge: document.getElementById("cartCountBadge"),
      btnCartTop: document.getElementById("btnCartTop"),

      mask: document.getElementById("mask"),
      sheet: document.getElementById("sheet"),
      sheetClose: document.getElementById("sheetClose"),

      cartItems: document.getElementById("cartItems"),
      cartEmpty: document.getElementById("cartEmpty"),
      total: document.getElementById("total"),

      mode: document.getElementById("mode"),
      zone: document.getElementById("zone"),
      fullname: document.getElementById("fullname"),
      phone: document.getElementById("phone"),
      address: document.getElementById("address"),
      note: document.getElementById("note"),
      addrField: document.getElementById("addrField"),

      clear: document.getElementById("clear"),
      copy: document.getElementById("copy"),
      order: document.getElementById("order"),

      toast: document.getElementById("toast"),

      // ‚úÖ media modal
      mediaMask: document.getElementById("mediaMask"),
      mediaModal: document.getElementById("mediaModal"),
      mediaClose: document.getElementById("mediaClose"),
      mediaWrap: document.getElementById("mediaWrap"),
      mediaTitle: document.getElementById("mediaTitle"),
      mediaSub: document.getElementById("mediaSub"),
    };

    /* ===========================
       HELPERS
       =========================== */
    function loadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        const parsed = JSON.parse(raw);
        return (parsed && typeof parsed === "object") ? parsed : fallback;
      }catch(_){ return fallback; }
    }
    function saveJSON(key, value){
      try{ localStorage.setItem(key, JSON.stringify(value)); }catch(_){}
    }
    function escapeHTML(str){
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
      }[s]));
    }
    function money(n){
      const v = Number(n || 0);
      return v.toFixed(2) + " ‚Ç¨";
    }
    function toast(msg){
      el.toast.textContent = msg;
      el.toast.classList.remove("opacity-0");
      el.toast.classList.add("opacity-100");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{
        el.toast.classList.add("opacity-0");
        el.toast.classList.remove("opacity-100");
      }, 1500);
    }
    function haptic(type="light"){
      try{ tg?.HapticFeedback?.impactOccurred?.(type); }catch(_){}
    }
    function uniq(arr){ return [...new Set(arr)]; }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function getProduct(id){ return PRODUCTS.find(p=>p.id===id); }

    async function copyText(text){
      try{
        if(tg?.Clipboard?.writeText){ await tg.Clipboard.writeText(text); return true; }
      }catch(_){}
      if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(text); return true; }
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position="fixed"; ta.style.left="-9999px"; ta.style.top="-9999px";
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      if(!ok) throw new Error("copy failed");
      return true;
    }

    function cartCount(){
      let c=0;
      for(const qty of Object.values(state.cart)) c += Number(qty||0);
      return c;
    }
    function cartItems(){
      const items = [];
      for(const [id, qty] of Object.entries(state.cart)){
        const p = getProduct(id);
        const q = Number(qty||0);
        if(p && q>0) items.push({p, qty:q});
      }
      return items;
    }
    function cartTotal(){
      return cartItems().reduce((sum, it)=>sum + (Number(it.p.price||0)*it.qty), 0);
    }
    function setQty(id, qty){
      qty = clamp(Number(qty||0), 0, 99);
      if(qty<=0) delete state.cart[id];
      else state.cart[id] = qty;
      saveJSON(CART_KEY, state.cart);
      renderAll();
    }

    /* ===========================
       ‚úÖ MEDIA MODAL (NEW)
       =========================== */
    function openMediaModal(productId){
      const p = getProduct(productId);
      if(!p){ toast("Produit introuvable"); return; }

      const m = p.media;
      if(!m || !m.src){
        toast("Aucun m√©dia pour ce produit");
        haptic("rigid");
        return;
      }

      // reset
      el.mediaWrap.innerHTML = "";

      el.mediaTitle.textContent = p.name || "Produit";
      el.mediaSub.textContent = `${p.id} ‚Ä¢ ${p.origin || ""}`.trim();

      if(m.type === "video"){
        const v = document.createElement("video");
        v.src = m.src;
        v.controls = true;
        v.playsInline = true;
        v.preload = "metadata";
        v.className = "absolute inset-0 h-full w-full object-contain bg-black";
        el.mediaWrap.appendChild(v);
      }else{
        const img = document.createElement("img");
        img.src = m.src;
        img.alt = p.name || "Produit";
        img.loading = "lazy";
        img.referrerPolicy = "no-referrer";
        img.className = "absolute inset-0 h-full w-full object-contain bg-black select-none";
        el.mediaWrap.appendChild(img);
      }

      el.mediaMask.classList.remove("opacity-0","pointer-events-none");
      el.mediaMask.classList.add("opacity-100");

      el.mediaModal.classList.remove("opacity-0","pointer-events-none");
      el.mediaModal.classList.add("opacity-100");

      haptic("light");
    }

    function closeMediaModal(){
      // stop video if any
      const v = el.mediaWrap.querySelector("video");
      if(v){ try{ v.pause(); v.currentTime = 0; }catch(_){ } }

      el.mediaMask.classList.add("opacity-0","pointer-events-none");
      el.mediaMask.classList.remove("opacity-100");

      el.mediaModal.classList.add("opacity-0","pointer-events-none");
      el.mediaModal.classList.remove("opacity-100");
    }

    // close handlers
    el.mediaClose.addEventListener("click", closeMediaModal);
    el.mediaMask.addEventListener("click", closeMediaModal);
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") closeMediaModal();
    });

    /* ===========================
       FILTERS
       =========================== */
    function buildChips(){
      const origins = uniq(PRODUCTS.map(p=>p.origin));
      const categories = uniq(PRODUCTS.map(p=>p.category));
      const tags = uniq(PRODUCTS.flatMap(p=>p.tags||[]));

      const chips = [];
      chips.push({key:"ALL", label:"Tout"});
      for(const c of categories) chips.push({key:`CAT:${c}`, label:c});
      for(const o of origins) chips.push({key:`ORI:${o}`, label:o});
      for(const t of tags) chips.push({key:`TAG:${t}`, label:`#${t}`});
      chips.push({key:"RESET", label:"‚ôªÔ∏è Reset", reset:true});

      el.chipsRow.innerHTML = "";
      for(const ch of chips){
        const b = document.createElement("button");
        b.type = "button";

        const base = "inline-flex items-center gap-2 rounded-full border px-4 py-2 text-[13px] whitespace-nowrap transition active:translate-y-[1px] active:scale-[.99]";
        const inactive = "border-white/10 bg-white/5 text-white/90 hover:border-white/15 hover:bg-white/10";
        const active = "border-[rgba(255,212,0,.30)] text-[#141414] font-black shadow-[0_18px_30px_rgba(255,212,0,.10)]";
        const reset = "border-dashed border-white/15 bg-white/5 text-white/85 hover:border-white/20 hover:bg-white/10";

        if(ch.reset){
          b.className = `${base} ${reset}`;
        }else if(ch.key === state.filter){
          b.className = `${base} ${active} bg-gradient-to-br from-accent to-accent2`;
        }else{
          b.className = `${base} ${inactive}`;
        }

        b.textContent = ch.label;
        b.addEventListener("click", ()=>{
          if(ch.key === "RESET"){
            state.filter = "ALL";
            state.q = "";
            el.q.value = "";
            renderAll();
            toast("R√©initialis√©");
            haptic("soft");
            return;
          }
          state.filter = ch.key;
          renderAll();
          haptic("light");
        });

        el.chipsRow.appendChild(b);
      }
    }

    function applyFilter(p){
      const q = (state.q||"").trim().toLowerCase();
      if(q){
        const blob = [p.id, p.name, p.category, p.origin, p.quality, p.desc, ...(p.tags||[])].join(" ").toLowerCase();
        if(!blob.includes(q)) return false;
      }
      const f = state.filter;
      if(f === "ALL") return true;
      if(f.startsWith("CAT:")) return p.category === f.slice(4);
      if(f.startsWith("ORI:")) return p.origin === f.slice(4);
      if(f.startsWith("TAG:")) return (p.tags||[]).includes(f.slice(4));
      return true;
    }

    /* ===========================
       RENDER PRODUCTS (UPGRADED + VIEW BUTTON)
       =========================== */
    function renderList(){
      const filtered = PRODUCTS.filter(applyFilter);
      el.list.innerHTML = "";

      el.countInfo.textContent = `${filtered.length} produit(s)`;

      if(filtered.length === 0){
        el.empty.classList.remove("hidden");
        return;
      }
      el.empty.classList.add("hidden");

      for(const p of filtered){
        const qty = Number(state.cart[p.id]||0);

        const tags = (p.tags||[]).slice(0,4)
          .map(t=>`<span class="rounded-full border border-white/10 bg-white/5 px-3 py-1.5 text-[11.5px] text-white/90"><span class="font-black text-accent">#</span>${escapeHTML(t)}</span>`)
          .join("");

        const hasMedia = !!(p.media && p.media.src);

        const card = document.createElement("article");
        card.className = "relative overflow-hidden rounded-xl4 border border-white/10 bg-white/5 p-4 shadow-soft transition hover:-translate-y-0.5 hover:border-white/15 hover:bg-white/10";

        card.innerHTML = `
          <div class="pointer-events-none absolute inset-[-45%] opacity-65 blur-[30px] animate-drift
                      bg-[radial-gradient(circle_at_22%_25%,rgba(255,212,0,.18),transparent_58%),radial-gradient(circle_at_82%_18%,rgba(46,229,157,.12),transparent_60%),radial-gradient(circle_at_55%_120%,rgba(105,140,255,.10),transparent_62%)]"></div>

          <div class="relative">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-black/20 px-3 py-1.5 text-[12px] text-muted shadow-soft">
                  <span class="h-1.5 w-1.5 rounded-full bg-good"></span>
                  <span class="font-black text-white/90">${escapeHTML(p.quality)}</span>
                  <span class="text-white/40">‚Ä¢</span>
                  <span>${escapeHTML(p.origin)}</span>
                </div>

                <h2 class="mt-2 text-[16.5px] font-black tracking-[.2px] leading-tight">${escapeHTML(p.name)}</h2>
                <p class="mt-1 text-[12.8px] leading-snug text-muted">${escapeHTML(p.desc)}</p>
              </div>

              <div class="flex flex-col items-end gap-2">
                <div class="rounded-full border border-[rgba(255,212,0,.18)] bg-[rgba(255,212,0,.08)] px-3 py-1.5 text-[12px] text-[rgba(255,247,215,.92)]">
                  R√©f <b class="font-black text-accent">${escapeHTML(p.id)}</b>
                </div>
                <div class="flex items-baseline gap-2 whitespace-nowrap">
                  <div class="text-[18px] font-black tracking-[.2px]">${money(p.price).replace(" ‚Ç¨","")}</div>
                  <div class="text-[12px] font-bold text-muted2">‚Ç¨ / unit√©</div>
                </div>
              </div>
            </div>

            <div class="mt-3 flex flex-wrap gap-2">
              ${tags}
              ${tags ? "" : `<span class="rounded-full border border-white/10 bg-white/5 px-3 py-1.5 text-[11.5px] text-white/70">‚Äî</span>`}
            </div>

            <div class="mt-3 grid gap-2.5 sm:grid-cols-3">
              <button class="rounded-xl3 border border-white/10 bg-white/5 px-4 py-3 font-black tracking-[.2px] text-white/90 shadow-soft transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10"
                      type="button" data-act="copyref" data-id="${p.id}">
                üìã Copier la r√©f
              </button>

              <button class="rounded-xl3 border border-white/10 bg-white/5 px-4 py-3 font-black tracking-[.2px] text-white/90 shadow-soft transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10 ${hasMedia ? "" : "opacity-50 cursor-not-allowed"}"
                      type="button" data-act="view" data-id="${p.id}" ${hasMedia ? "" : "disabled"}>
                üëÅÔ∏è Voir le produit
              </button>

              <button class="rounded-xl3 px-4 py-3 font-black tracking-[.2px] text-[#141414] shadow-accent transition active:translate-y-[1px] active:scale-[.99] hover:brightness-105 bg-gradient-to-br from-accent to-accent2"
                      type="button" data-act="add" data-id="${p.id}">
                ${qty>0 ? "‚úî Ajout√© ‚Ä¢ x"+qty : "+ Ajouter au panier"}
              </button>
            </div>
          </div>
        `;

        card.addEventListener("click", (e)=>{
          const btn = e.target.closest("[data-act]");
          if(!btn) return;
          e.preventDefault();
          e.stopPropagation();

          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");

          if(act === "copyref"){
            copyText(id)
              .then(()=>{ toast("R√©f√©rence copi√©e"); haptic("light"); })
              .catch(()=>{ toast("Copie impossible"); haptic("rigid"); });
          }

          if(act === "view"){
            openMediaModal(id);
          }

          if(act === "add"){
            const cur = Number(state.cart[id] || 0);
            setQty(id, cur + 1);
            toast("Ajout√© au panier");
            haptic("light");
          }
        });

        el.list.appendChild(card);
      }
    }

    /* ===========================
       CART BAR / SHEET
       =========================== */
    function renderCartBar(){
      const count = cartCount();
      const total = cartTotal();

      el.cartHint.textContent = count
        ? `${count} article(s) ‚Ä¢ Total indicatif ${money(total)}`
        : "Aucun article";

      el.cartCountBadge.textContent = count;

      if(count > 0){
        el.cartCountBadge.className =
          "grid h-[34px] min-w-[34px] place-items-center rounded-full px-2 font-black text-[13px] text-[#141414] border border-[rgba(255,212,0,.30)] bg-gradient-to-br from-accent to-accent2";
      } else {
        el.cartCountBadge.className =
          "grid h-[34px] min-w-[34px] place-items-center rounded-full border border-[rgba(255,212,0,.22)] bg-[rgba(255,212,0,.16)] px-2 font-black text-[13px] text-[rgba(255,247,215,.95)]";
      }
    }

    function openSheet(){
      el.mask.classList.remove("opacity-0","pointer-events-none");
      el.mask.classList.add("opacity-100");
      el.sheet.style.bottom = `calc(10px + var(--safe-bottom))`;
      renderCartSheet();
      haptic("light");
    }

    function closeSheet(){
      el.mask.classList.add("opacity-0","pointer-events-none");
      el.mask.classList.remove("opacity-100");
      el.sheet.style.bottom = `calc(-100% - 40px)`;
    }

    function applyModeUI(){
      const isDelivery = el.mode.value === "LIVRAISON";
      el.addrField.classList.toggle("hidden", !isDelivery);
    }

    function loadFormIntoUI(){
      el.mode.value = state.form.mode || "LIVRAISON";
      el.zone.value = state.form.zone || "59";
      el.fullname.value = state.form.fullname || "";
      el.phone.value = state.form.phone || "";
      el.address.value = state.form.address || "";
      el.note.value = state.form.note || "";
      applyModeUI();
    }

    function saveFormFromUI(){
      state.form = {
        mode: el.mode.value,
        zone: el.zone.value,
        fullname: el.fullname.value.trim(),
        phone: el.phone.value.trim(),
        address: el.address.value.trim(),
        note: el.note.value.trim()
      };
      saveJSON(FORM_KEY, state.form);
    }

    function renderCartSheet(){
      const items = cartItems();
      el.cartItems.innerHTML = "";
      el.cartEmpty.classList.toggle("hidden", items.length>0);

      for(const it of items){
        const line = Number(it.p.price||0) * it.qty;

        const row = document.createElement("div");
        row.className = "mb-2.5 flex items-start justify-between gap-3 rounded-xl3 border border-white/10 bg-black/20 p-3";
        row.innerHTML = `
          <div class="min-w-0">
            <div class="truncate text-[13.8px] font-black tracking-[.15px]">${escapeHTML(it.p.name)}</div>
            <div class="mt-1.5 flex flex-wrap gap-2 text-[12px] text-muted">
              <span class="rounded-full border border-white/10 bg-white/5 px-2 py-1">${escapeHTML(it.p.origin)}</span>
              <span class="rounded-full border border-white/10 bg-white/5 px-2 py-1">ID: ${escapeHTML(it.p.id)}</span>
              <span class="rounded-full border border-white/10 bg-white/5 px-2 py-1">PU: ${money(it.p.price)}</span>
            </div>
          </div>

          <div class="flex flex-none flex-col items-end gap-2.5">
            <div class="whitespace-nowrap text-[13.5px] font-black">${money(line)}</div>

            <div class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-2.5 py-2 select-none">
              <button type="button" data-act="dec" data-id="${it.p.id}"
                      class="grid h-7 w-7 place-items-center rounded-full border border-white/10 bg-black/20 font-black text-white/90 active:scale-[.98]">‚àí</button>
              <span class="w-7 text-center text-[13px] font-black text-white/90">${it.qty}</span>
              <button type="button" data-act="inc" data-id="${it.p.id}"
                      class="grid h-7 w-7 place-items-center rounded-full border border-white/10 bg-black/20 font-black text-white/90 active:scale-[.98]">+</button>
            </div>

            <div data-act="remove" data-id="${it.p.id}"
                 class="cursor-pointer select-none rounded-full border border-[rgba(255,77,77,.18)] bg-[rgba(255,77,77,.06)] px-2.5 py-1.5 text-[12px] text-[rgba(255,120,120,.95)]">
              Retirer
            </div>
          </div>
        `;

        row.addEventListener("click",(e)=>{
          const b = e.target.closest("[data-act]");
          if(!b) return;

          const act = b.getAttribute("data-act");
          const id = b.getAttribute("data-id");
          const cur = Number(state.cart[id]||0);

          if(act === "inc") setQty(id, cur+1);
          if(act === "dec") setQty(id, cur-1);
          if(act === "remove") setQty(id, 0);

          haptic("soft");
        });

        el.cartItems.appendChild(row);
      }

      el.total.textContent = money(cartTotal());
      applyModeUI();
      loadFormIntoUI();
    }

    /* ===========================
       ORDER
       =========================== */
    function buildOrderText(){
      const items = cartItems();
      const total = cartTotal();
      const f = state.form;

      const lines = [];
      lines.push("üì¶ Ma Commande SLR BOOST");
      lines.push("");
      lines.push("üõí Produits :");
      for(const it of items){
        const line = Number(it.p.price||0) * it.qty;
        lines.push(`‚Ä¢ ${it.p.origin} ${it.p.name} ‚Äî ${it.p.id} √ó${it.qty} = ${money(line)}`);
      }
      lines.push("");
      lines.push(`üí∞ Total indicatif : ${money(total)}`);
      lines.push("‚ö†Ô∏è Le montant final peut varier (disponibilit√© / ajustements).");
      lines.push("");
      lines.push("üìç Livraison / Retrait :");
      lines.push(`üöö Mode : ${f.mode === "LIVRAISON" ? "Livraison" : "Sur place"}`);
      lines.push(`üìç Zone : ${f.zone || "-"}`);
      lines.push(`üë§ Nom : ${f.fullname || "-"}`);
      lines.push(`üìû T√©l√©phone : ${f.phone || "-"}`);
      if(f.mode === "LIVRAISON") lines.push(`üè† Adresse : ${f.address || "-"}`);
      if(f.note){
        lines.push("");
        lines.push("üí¨ Message :");
        lines.push(f.note);
      }
      try{
        const u = tg?.initDataUnsafe?.user;
        if(u){
          const who = [u.first_name, u.last_name].filter(Boolean).join(" ");
          const uname = u.username ? `@${u.username}` : "";
          lines.push("");
          lines.push(`üëÅÔ∏è Telegram : ${who}${uname ? " ("+uname+")" : ""}`);
        }
      }catch(_){}
      lines.push("");
      lines.push("‚úÖ Merci de confirmer la dispo + le prix final.");
      return lines.join("\n");
    }

    function validateBeforeOrder(){
      if(!cartItems().length){ toast("Panier vide"); haptic("rigid"); return false; }

      const f = state.form;
      if(!f.fullname || f.fullname.length < 2){ toast("Ajoute ton nom/pr√©nom"); haptic("rigid"); return false; }
      if(!f.phone || f.phone.length < 6){ toast("Ajoute un t√©l√©phone valide"); haptic("rigid"); return false; }
      if(f.mode === "LIVRAISON" && (!f.address || f.address.length < 6)){
        toast("Ajoute une adresse (livraison)"); haptic("rigid"); return false;
      }
      return true;
    }

    function openChatWithPrefill(username, text){
      const url = `https://t.me/${encodeURIComponent(username)}?text=${encodeURIComponent(text)}`;
      try{
        if(tg?.openTelegramLink){ tg.openTelegramLink(url); return true; }
        if(tg?.openLink){ tg.openLink(url); return true; }
      }catch(_){}
      window.open(url, "_blank", "noopener,noreferrer");
      return true;
    }

    async function handleOrder(){
      saveFormFromUI();
      if(!validateBeforeOrder()) return;

      const msg = buildOrderText();

      try{ await copyText(msg); }catch(_){}
      toast("R√©cap copi√© ‚úÖ");

      openChatWithPrefill(CONTACT_USERNAME, msg);
      haptic("light");
    }

    /* ===========================
       INIT / EVENTS
       =========================== */
    function renderAll(){
      buildChips();
      renderList();
      renderCartBar();

      const opened = el.mask.classList.contains("opacity-100") && !el.mask.classList.contains("pointer-events-none");
      if(opened) renderCartSheet();
    }

    el.q.addEventListener("input", ()=>{
      state.q = el.q.value || "";
      renderAll();
    });

    el.cartPreview.addEventListener("click", openSheet);
    el.btnCartTop.addEventListener("click", openSheet);
    el.sheetClose.addEventListener("click", closeSheet);
    el.mask.addEventListener("click", closeSheet);

    el.mode.addEventListener("change", ()=>{ applyModeUI(); saveFormFromUI(); });
    ["zone","fullname","phone","address","note"].forEach(id=>{
      el[id].addEventListener("input", saveFormFromUI);
      el[id].addEventListener("change", saveFormFromUI);
    });

    el.clear.addEventListener("click", ()=>{
      state.cart = {};
      saveJSON(CART_KEY, state.cart);
      renderAll();
      toast("Panier vid√©");
      haptic("soft");
    });

    el.copy.addEventListener("click", async ()=>{
      saveFormFromUI();
      const msg = buildOrderText();
      try{ await copyText(msg); toast("R√©cap copi√©"); haptic("light"); }
      catch(_){ toast("Copie impossible"); haptic("rigid"); }
    });

    el.order.addEventListener("click", handleOrder);

    // Telegram Back button behavior
    try{
      if(tg?.BackButton){
        tg.BackButton.show();
        tg.BackButton.onClick(()=>{
          const mediaOpen = el.mediaMask.classList.contains("opacity-100") && !el.mediaMask.classList.contains("pointer-events-none");
          const cartOpen  = el.mask.classList.contains("opacity-100") && !el.mask.classList.contains("pointer-events-none");

          if(mediaOpen) closeMediaModal();
          else if(cartOpen) closeSheet();
          else tg.close?.();
        });
      }
    }catch(_){}

    // Prefill UI from stored form
    function init(){
      el.mode.value = state.form.mode || "LIVRAISON";
      el.zone.value = state.form.zone || "59";
      el.fullname.value = state.form.fullname || "";
      el.phone.value = state.form.phone || "";
      el.address.value = state.form.address || "";
      el.note.value = state.form.note || "";
      applyModeUI();
      renderAll();
    }
    init();
  </script>
</body>
</html>
