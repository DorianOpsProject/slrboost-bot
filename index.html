<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>SLR BOOST ‚Äî Mini App</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            bg0: '#070A10',
            bg1: '#0B1020',
            glass: 'rgba(255,255,255,.06)',
            glass2: 'rgba(255,255,255,.09)',
            stroke: 'rgba(255,255,255,.10)',
            stroke2: 'rgba(255,255,255,.16)',
            text: 'rgba(250,253,255,.96)',
            muted: 'rgba(250,253,255,.66)',
            muted2: 'rgba(250,253,255,.50)',
            accent: '#FFD400',
            accent2: '#FFB800',
            good: '#2EE59D',
            bad: '#FF4D4D',
          },
          boxShadow: {
            soft: '0 10px 26px rgba(0,0,0,.42)',
            deep: '0 18px 60px rgba(0,0,0,.55)',
            accent: '0 18px 34px rgba(255,212,0,.14)',
          },
          borderRadius: {
            xl2: '18px',
            xl3: '24px',
            xl4: '26px',
          },
          keyframes: {
            floaty: { '0%,100%': { transform: 'translate3d(0,0,0) scale(1)' }, '50%': { transform: 'translate3d(0,26px,0) scale(1.06)' } },
            floaty2: { '0%,100%': { transform: 'translate3d(0,0,0) scale(1)' }, '50%': { transform: 'translate3d(0,18px,0) scale(1.05)' } },
            floaty3: { '0%,100%': { transform: 'translate3d(0,0,0) scale(1)' }, '50%': { transform: 'translate3d(0,30px,0) scale(1.06)' } },
            sheen: { 'to': { transform: 'rotate(360deg)' } },
            drift: { '0%,100%': { transform: 'translate3d(0,0,0) scale(1)' }, '50%': { transform: 'translate3d(12px,12px,0) scale(1.03)' } },
            sk: { '0%': { backgroundPosition: '0% 0' }, '100%': { backgroundPosition: '-220% 0' } }
          },
          animation: {
            floaty: 'floaty 14s ease-in-out infinite',
            floaty2: 'floaty2 17s ease-in-out infinite',
            floaty3: 'floaty3 19s ease-in-out infinite',
            sheen: 'sheen 2.8s linear infinite',
            drift: 'drift 11s ease-in-out infinite',
            sk: 'sk 1.1s ease-in-out infinite'
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    html, body { height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 15% 0%, rgba(255,212,0,.14), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(46,229,157,.10), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(105,140,255,.10), transparent 60%),
        linear-gradient(180deg, #070A10, #0B1020);
      overflow-x:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display","SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; scroll-behavior:auto !important; }
    }
    .scrollbar::-webkit-scrollbar{ width:10px; }
    .scrollbar::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }
    .sheet-drag { transform: translateX(-50%); }
  </style>
</head>

<body class="text-text">
  <!-- FX -->
  <div class="pointer-events-none fixed inset-0 z-0 overflow-hidden opacity-95" aria-hidden="true">
    <div class="absolute -left-[180px] -top-[220px] h-[520px] w-[520px] rounded-full blur-[34px] opacity-[.16] animate-floaty"
         style="background: radial-gradient(circle at 35% 30%, rgba(255,212,0,.95), rgba(255,212,0,0) 62%);"></div>
    <div class="absolute -right-[220px] top-[60px] h-[520px] w-[520px] rounded-full blur-[34px] opacity-[.16] animate-floaty2"
         style="background: radial-gradient(circle at 40% 35%, rgba(46,229,157,.95), rgba(46,229,157,0) 62%);"></div>
    <div class="absolute left-[24%] -bottom-[320px] h-[520px] w-[520px] rounded-full blur-[34px] opacity-[.16] animate-floaty3"
         style="background: radial-gradient(circle at 50% 40%, rgba(105,140,255,.95), rgba(105,140,255,0) 62%);"></div>
  </div>

  <div class="relative z-10 mx-auto max-w-[980px] px-[14px] pb-[calc(98px+var(--safe-bottom))] pt-[calc(14px+var(--safe-top))]">
    <!-- TOPBAR -->
    <header class="sticky top-0 z-20 -mx-[14px] mb-3 border-b border-white/5 bg-gradient-to-b from-[#070A10]/90 to-[#070A10]/55 px-[14px] pb-3 pt-[calc(14px+var(--safe-top))] backdrop-blur-[14px]">
      <div class="flex items-center justify-between gap-3">
        <div class="flex min-w-0 items-center gap-3">
          <div class="relative flex h-[46px] w-[46px] flex-none items-center justify-center overflow-hidden rounded-[16px] text-[#101010] shadow-[0_16px_30px_rgba(255,212,0,.16)]"
               style="background: linear-gradient(135deg, #FFD400, #FFB800);">
            <div class="absolute inset-[-40%] opacity-60 animate-sheen"
                 style="background: conic-gradient(from 180deg, rgba(255,255,255,0), rgba(255,255,255,.55), rgba(255,255,255,0));"></div>
            <span class="relative text-[18px] font-black">‚ö°</span>
          </div>
          <div class="min-w-0">
            <h1 class="truncate text-[18px] font-black tracking-[.2px]">SLR BOOST</h1>
            <p class="truncate text-[12.5px] text-muted">Catalogue ‚Ä¢ Que de la frappe ‚Ä¢ Commande en priv√©</p>
          </div>
        </div>

        <div class="flex flex-none items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-2 shadow-soft">
          <span class="h-2.5 w-2.5 rounded-full bg-good shadow-[0_0_0_3px_rgba(46,229,157,.10)]"></span>
          <span class="text-[12px] tracking-[.2px] text-muted">Online</span>
        </div>
      </div>

      <!-- Search + cart icon -->
      <div class="mt-3 flex items-center gap-2.5">
        <div class="flex flex-1 items-center gap-2.5 rounded-xl2 border border-white/10 bg-white/5 px-3.5 py-3 shadow-soft">
          <svg class="opacity-80" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18.5a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="2" opacity=".9"/>
            <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".9"/>
          </svg>
          <input id="q" class="w-full bg-transparent text-[14px] text-text outline-none placeholder:text-white/45"
                 type="search" placeholder="Rechercher un produit, une r√©f√©rence, un tag‚Ä¶" autocomplete="off"/>
        </div>

        <button id="btnCartTop" type="button"
                class="grid h-[46px] w-[46px] flex-none place-items-center rounded-[16px] border border-white/10 bg-white/5 text-white/90 shadow-soft transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10"
                aria-label="Ouvrir le panier">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6h15l-1.7 8.5a2 2 0 01-2 1.5H9.2a2 2 0 01-2-1.6L6 6z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M6 6l-2-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="9.5" cy="20" r="1.5" fill="currentColor"/>
            <circle cx="17.5" cy="20" r="1.5" fill="currentColor"/>
          </svg>
        </button>
      </div>

      <!-- Chips -->
      <div id="chipsRow" class="mt-3 flex items-center gap-2.5 overflow-x-auto pb-0.5 [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden"></div>
    </header>

    <main>
      <div id="list" class="flex flex-col gap-3"></div>
      <div id="emptyState" class="hidden rounded-xl2 border border-dashed border-white/15 bg-white/5 p-4 text-center text-[13px] leading-snug text-muted">
        Aucun produit ne correspond √† ta recherche.
      </div>
    </main>
  </div>

  <!-- Bottom bar -->
  <div class="fixed bottom-0 left-0 right-0 z-40 border-t border-white/5 bg-gradient-to-b from-[#070A10]/0 to-[#070A10]/90 px-[14px] pb-[calc(10px+var(--safe-bottom))] pt-2.5 backdrop-blur-[12px]">
    <div class="mx-auto flex max-w-[980px] items-center justify-between gap-2.5">
      <div id="cartPreview"
           class="flex flex-1 cursor-pointer items-center justify-between gap-3 rounded-xl3 border border-white/10 bg-white/5 p-3 shadow-soft transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10"
           role="button" aria-label="Ouvrir le panier">
        <div class="min-w-0">
          <div class="flex items-center gap-2 font-black text-[13px]">üõí Panier</div>
          <div id="cartHint" class="truncate text-[12px] text-muted">Aucun article</div>
        </div>
        <div id="cartCountBadge"
             class="grid h-[34px] min-w-[34px] place-items-center rounded-full border border-[rgba(255,212,0,.22)] bg-[rgba(255,212,0,.16)] px-2 font-black text-[13px] text-[rgba(255,247,215,.95)]">
          0
        </div>
      </div>
    </div>
  </div>

  <!-- Sheet -->
  <div id="mask" class="fixed inset-0 z-[60] bg-black/60 opacity-0 pointer-events-none transition-opacity"></div>

  <aside id="sheet"
         class="fixed left-1/2 z-[61] w-[min(980px,calc(100%-18px))] -translate-x-1/2 rounded-[26px] border border-white/10 shadow-deep backdrop-blur-[18px] transition-[bottom] duration-300 [transition-timing-function:cubic-bezier(.2,.9,.2,1)] sheet-drag"
         style="bottom: calc(-100% - 40px);
                background:
                radial-gradient(900px 340px at 20% 0%, rgba(255,212,0,.14), transparent 60%),
                radial-gradient(900px 340px at 80% 0%, rgba(46,229,157,.10), transparent 62%),
                rgba(12,16,26,.88);"
         role="dialog" aria-modal="true" aria-label="Panier et commande">

    <div class="flex items-center justify-between gap-2.5 border-b border-white/10 px-3.5 py-3">
      <div class="text-[14px] font-black tracking-[.2px]">Panier</div>
      <button id="sheetClose" type="button"
              class="rounded-xl2 border border-white/10 bg-white/5 px-3 py-2 text-white/90 transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10">
        Fermer
      </button>
    </div>

    <div class="mx-auto mt-2 h-1.5 w-11 rounded-full bg-white/20" aria-hidden="true"></div>

    <div id="sheetBody" class="scrollbar max-h-[min(64vh,560px)] overflow-auto px-3.5 pb-3.5 pt-3">
      <div class="rounded-xl2 border border-white/10 bg-white/5 p-3.5">
        <h3 class="mb-2.5 text-[13px] font-black tracking-[.2px] text-white/95">Produits s√©lectionn√©s</h3>
        <div id="cartItems"></div>
        <div id="cartEmpty" class="hidden rounded-xl2 border border-dashed border-white/15 bg-white/5 p-4 text-center text-[13px] leading-snug text-muted">
          Ton panier est vide.
        </div>
      </div>

      <div class="mt-3 rounded-xl2 border border-white/10 bg-white/5 p-3.5">
        <h3 class="mb-2.5 text-[13px] font-black tracking-[.2px] text-white/95">Livraison / Sur place</h3>

        <div class="grid grid-cols-1 gap-2.5 sm:grid-cols-2">
          <div class="flex flex-col gap-1.5">
            <label class="text-[12px] text-muted2" for="mode">Mode</label>
            <select id="mode" class="rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none">
              <option value="LIVRAISON">Livraison</option>
              <option value="SUR_PLACE">Sur place</option>
            </select>
          </div>

          <div class="flex flex-col gap-1.5">
            <label class="text-[12px] text-muted2" for="zone">Zone</label>
            <select id="zone" class="rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none">
              <option value="59">59</option>
              <option value="62">62</option>
              <option value="BELGIUM">BELGIUM</option>
              <option value="AUTRE">Autre</option>
            </select>
          </div>

          <div class="flex flex-col gap-1.5">
            <label class="text-[12px] text-muted2" for="fullname">Nom / Pr√©nom</label>
            <input id="fullname" class="rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none"
                   type="text" placeholder="Ex: Alex D." autocomplete="name">
          </div>

          <div class="flex flex-col gap-1.5">
            <label class="text-[12px] text-muted2" for="phone">T√©l√©phone</label>
            <input id="phone" class="rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none"
                   type="tel" placeholder="Ex: 06 00 00 00 00" autocomplete="tel">
          </div>

          <div id="addrField" class="flex flex-col gap-1.5 sm:col-span-2">
            <label class="text-[12px] text-muted2" for="address">Adresse (si livraison)</label>
            <input id="address" class="rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none"
                   type="text" placeholder="Rue + num√©ro + ville" autocomplete="street-address">
          </div>

          <div class="flex flex-col gap-1.5 sm:col-span-2">
            <label class="text-[12px] text-muted2" for="note">Message (optionnel)</label>
            <textarea id="note" class="min-h-[82px] resize-y rounded-xl2 border border-white/10 bg-black/20 px-3 py-3 text-[14px] text-text outline-none"
                      placeholder="Infos utiles, cr√©neau, pr√©cision‚Ä¶"></textarea>
          </div>
        </div>

        <div class="mt-2.5 rounded-xl2 border border-[rgba(255,212,0,.18)] bg-[rgba(255,212,0,.08)] px-3 py-2.5 text-[12px] leading-snug text-[rgba(255,247,215,.92)]">
          ‚ö†Ô∏è Le total affich√© est indicatif. Le montant final peut varier (disponibilit√© / ajustements).
        </div>
      </div>
    </div>

    <div class="border-t border-white/10 bg-black/10 px-3.5 py-3.5">
      <div class="flex items-center justify-between text-[12px] text-muted">
        <span>Total indicatif</span>
        <b id="total" class="text-[16px] font-black text-white/95">0.00 ‚Ç¨</b>
      </div>

      <div class="mt-2.5 flex flex-wrap gap-2.5">
        <button id="clear" type="button"
                class="flex-1 rounded-xl2 border border-white/10 bg-white/5 px-4 py-3 font-black tracking-[.2px] text-white/90 shadow-soft transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10">
          Vider
        </button>
        <button id="copy" type="button"
                class="flex-1 rounded-xl2 border border-white/10 bg-white/5 px-4 py-3 font-black tracking-[.2px] text-white/90 shadow-soft transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10">
          Copier le r√©cap
        </button>
        <button id="order" type="button"
                class="flex-[2_1_220px] rounded-xl2 px-4 py-3 font-black tracking-[.2px] text-[#141414] shadow-accent transition active:translate-y-[1px] active:scale-[.99] hover:brightness-105"
                style="background: linear-gradient(135deg, #FFD400, #FFB800);">
          Commander
        </button>
      </div>
    </div>
  </aside>

  <!-- Toast -->
  <div id="toast"
       class="fixed left-1/2 z-[90] max-w-[min(92vw,620px)] -translate-x-1/2 rounded-full border border-white/15 bg-[rgba(12,16,26,.86)] px-3 py-2 text-[13px] text-white/90 opacity-0 pointer-events-none shadow-deep backdrop-blur-[14px] transition"
       style="bottom: calc(100px + var(--safe-bottom));">
    OK
  </div>

  <script>
    const PRODUCTS = [
      { id:"SLR-P01", name:"Produit 01", category:"Catalogue", origin:"üá≤üá¶ Maroc", quality:"Premium", price:0.00, desc:"Description (exemple).", tags:["Nouveau"] },
      { id:"SLR-P02", name:"Produit 02", category:"Catalogue", origin:"üá≤üá¶ Maroc", quality:"Premium", price:0.00, desc:"Description (exemple).", tags:["Populaire"] },
      { id:"SLR-P03", name:"Produit 03", category:"Catalogue", origin:"üá≤üá¶ Maroc", quality:"Premium", price:0.00, desc:"Description (exemple).", tags:["Stock limit√©"] },
      { id:"SLR-P04", name:"Produit 04", category:"Catalogue", origin:"üá≤üá¶ Maroc", quality:"Premium", price:0.00, desc:"Description (exemple).", tags:[] },
      { id:"SLR-P05", name:"Produit 05", category:"Catalogue", origin:"üá≥üá± Pays-Bas", quality:"Premium", price:0.00, desc:"Description (exemple).", tags:["Best-seller"] },
      { id:"SLR-P06", name:"Produit 06", category:"Catalogue", origin:"üá≥üá± Pays-Bas", quality:"Premium", price:0.00, desc:"Description (exemple).", tags:[] },
      { id:"SLR-P07", name:"Produit 07", category:"Catalogue", origin:"üá∫üá∏ USA", quality:"Premium", price:0.00, desc:"Description (exemple).", tags:["USA"] },
      { id:"SLR-P08", name:"Produit 08", category:"Catalogue", origin:"üá≥üá± Pays-Bas", quality:"Premium", price:0.00, desc:"Description (exemple).", tags:[] },
      { id:"SLR-P09", name:"Produit 09", category:"Catalogue", origin:"üá∫üá∏ USA", quality:"Premium", price:0.00, desc:"Description (exemple).", tags:[] },
      { id:"SLR-P10", name:"Produit 10", category:"Catalogue", origin:"üá∫üá∏ USA", quality:"Premium", price:0.00, desc:"Description (exemple).", tags:[] },
      { id:"SLR-P11", name:"Produit 11", category:"Catalogue", origin:"üá®üá¶ Canada", quality:"Premium", price:0.00, desc:"Description (exemple).", tags:["Canada"] }
    ];

    const CONTACT_USERNAME = "Petter59000XSLR";
    const CART_KEY = "slr_cart_tw_v1";
    const FORM_KEY = "slr_form_tw_v1";

    const tg = window.Telegram?.WebApp;
    try{
      tg?.ready?.();
      tg?.expand?.();
      tg?.setHeaderColor?.("#070A10");
      tg?.setBackgroundColor?.("#070A10");
    }catch(e){}

    const state = {
      q: "",
      filter: "ALL",
      cart: loadJSON(CART_KEY, {}),
      form: loadJSON(FORM_KEY, { mode:"LIVRAISON", zone:"59", fullname:"", phone:"", address:"", note:"" })
    };

    const el = {
      q: document.getElementById("q"),
      chipsRow: document.getElementById("chipsRow"),
      list: document.getElementById("list"),
      empty: document.getElementById("emptyState"),
      cartPreview: document.getElementById("cartPreview"),
      cartHint: document.getElementById("cartHint"),
      cartCountBadge: document.getElementById("cartCountBadge"),
      btnCartTop: document.getElementById("btnCartTop"),
      mask: document.getElementById("mask"),
      sheet: document.getElementById("sheet"),
      sheetClose: document.getElementById("sheetClose"),
      cartItems: document.getElementById("cartItems"),
      cartEmpty: document.getElementById("cartEmpty"),
      total: document.getElementById("total"),
      mode: document.getElementById("mode"),
      zone: document.getElementById("zone"),
      fullname: document.getElementById("fullname"),
      phone: document.getElementById("phone"),
      address: document.getElementById("address"),
      note: document.getElementById("note"),
      addrField: document.getElementById("addrField"),
      clear: document.getElementById("clear"),
      copy: document.getElementById("copy"),
      order: document.getElementById("order"),
      toast: document.getElementById("toast"),
    };

    function loadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        const parsed = JSON.parse(raw);
        return (parsed && typeof parsed === "object") ? parsed : fallback;
      }catch(_){ return fallback; }
    }
    function saveJSON(key, value){
      try{ localStorage.setItem(key, JSON.stringify(value)); }catch(_){}
    }
    function escapeHTML(str){
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
      }[s]));
    }
    function money(n){
      const v = Number(n || 0);
      return v.toFixed(2) + " ‚Ç¨";
    }
    function toast(msg){
      el.toast.textContent = msg;
      el.toast.classList.remove("opacity-0");
      el.toast.classList.add("opacity-100");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{
        el.toast.classList.add("opacity-0");
        el.toast.classList.remove("opacity-100");
      }, 1500);
    }
    function haptic(type="light"){
      try{ tg?.HapticFeedback?.impactOccurred?.(type); }catch(_){}
    }
    function uniq(arr){ return [...new Set(arr)]; }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function getProduct(id){ return PRODUCTS.find(p=>p.id===id); }

    function cartCount(){
      let c=0; for(const qty of Object.values(state.cart)) c += Number(qty||0);
      return c;
    }
    function cartItems(){
      const items = [];
      for(const [id, qty] of Object.entries(state.cart)){
        const p = getProduct(id);
        const q = Number(qty||0);
        if(p && q>0) items.push({p, qty:q});
      }
      return items;
    }
    function cartTotal(){
      return cartItems().reduce((sum, it)=>sum + (Number(it.p.price||0)*it.qty), 0);
    }
    function setQty(id, qty){
      qty = clamp(Number(qty||0), 0, 99);
      if(qty<=0) delete state.cart[id];
      else state.cart[id] = qty;
      saveJSON(CART_KEY, state.cart);
      renderAll();
    }

    function buildChips(){
      const origins = uniq(PRODUCTS.map(p=>p.origin));
      const categories = uniq(PRODUCTS.map(p=>p.category));
      const tags = uniq(PRODUCTS.flatMap(p=>p.tags||[]));

      const chips = [];
      chips.push({key:"ALL", label:"Tout"});
      for(const c of categories) chips.push({key:`CAT:${c}`, label:c});
      for(const o of origins) chips.push({key:`ORI:${o}`, label:o});
      for(const t of tags) chips.push({key:`TAG:${t}`, label:`#${t}`});
      chips.push({key:"RESET", label:"‚ôªÔ∏è R√©initialiser", reset:true});

      el.chipsRow.innerHTML = "";
      for(const ch of chips){
        const b = document.createElement("button");
        b.type = "button";

        const base = "inline-flex items-center gap-2 rounded-full border px-4 py-2 text-[13px] whitespace-nowrap transition active:translate-y-[1px] active:scale-[.99]";
        const inactive = "border-white/10 bg-white/5 text-white/90 hover:border-white/15 hover:bg-white/10";
        const active = "border-[rgba(255,212,0,.30)] text-[#141414] font-black shadow-[0_18px_30px_rgba(255,212,0,.10)]";
        const reset = "border-dashed border-white/15 bg-white/5 text-white/85 hover:border-white/20 hover:bg-white/10";

        if(ch.reset){
          b.className = `${base} ${reset}`;
        }else if(ch.key === state.filter){
          b.className = `${base} ${active}`;
          b.style.background = "linear-gradient(135deg,#FFD400,#FFB800)";
        }else{
          b.className = `${base} ${inactive}`;
        }

        b.textContent = ch.label;
        b.addEventListener("click", ()=>{
          if(ch.key === "RESET"){
            state.filter = "ALL";
            state.q = "";
            el.q.value = "";
            renderAll();
            toast("R√©initialis√©");
            haptic("soft");
            return;
          }
          state.filter = ch.key;
          renderAll();
          haptic("light");
        });

        el.chipsRow.appendChild(b);
      }
    }

    function applyFilter(p){
      const q = (state.q||"").trim().toLowerCase();
      if(q){
        const blob = [p.id, p.name, p.category, p.origin, p.quality, p.desc, ...(p.tags||[])].join(" ").toLowerCase();
        if(!blob.includes(q)) return false;
      }
      const f = state.filter;
      if(f === "ALL") return true;
      if(f.startsWith("CAT:")) return p.category === f.slice(4);
      if(f.startsWith("ORI:")) return p.origin === f.slice(4);
      if(f.startsWith("TAG:")) return (p.tags||[]).includes(f.slice(4));
      return true;
    }

    async function copyText(text){
      try{
        if(tg?.Clipboard?.writeText){ await tg.Clipboard.writeText(text); return true; }
      }catch(_){}
      if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(text); return true; }
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position="fixed"; ta.style.left="-9999px"; ta.style.top="-9999px";
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      if(!ok) throw new Error("copy failed");
      return true;
    }

    function renderList(){
      const filtered = PRODUCTS.filter(applyFilter);
      el.list.innerHTML = "";

      if(filtered.length === 0){
        el.empty.classList.remove("hidden");
        return;
      }
      el.empty.classList.add("hidden");

      for(const p of filtered){
        const qty = Number(state.cart[p.id]||0);
        const tags = (p.tags||[]).slice(0,4)
          .map(t=>`<span class="rounded-full border border-white/10 bg-white/5 px-3 py-1.5 text-[11.8px] text-white/90"><span class="font-black text-accent">#</span>${escapeHTML(t)}</span>`)
          .join("");

        const card = document.createElement("article");
        card.className = "relative overflow-hidden rounded-xl4 border border-white/10 bg-white/5 p-3.5 shadow-soft transition hover:-translate-y-0.5 hover:border-white/15 hover:bg-white/10";

        card.innerHTML = `
          <div class="pointer-events-none absolute inset-[-45%] opacity-60 blur-[26px] animate-drift"
               style="background:
                 radial-gradient(circle at 30% 30%, rgba(255,212,0,.16), transparent 58%),
                 radial-gradient(circle at 80% 20%, rgba(46,229,157,.12), transparent 60%);"></div>

          <div class="relative">
            <h2 class="text-[16px] font-black tracking-[.2px] leading-tight">${escapeHTML(p.name)}</h2>

            <div class="mt-2 grid gap-1.5 text-[12.8px] text-muted">
              <div>Provenance : <b class="font-black text-white/90">${escapeHTML(p.origin)}</b></div>
              <div>Type : <b class="font-black text-white/90">${escapeHTML(p.quality)}</b></div>
              <div class="text-muted">${escapeHTML(p.desc)}</div>
            </div>

            <div class="relative mt-2.5 flex flex-wrap gap-2">
              <span class="rounded-xl2 border border-white/15 bg-black/20 px-3 py-2 text-[12.5px] text-white/90" style="border-style:dashed">
                <span class="text-white/70">R√©f :</span> <b class="font-black">${escapeHTML(p.id)}</b>
              </span>
              ${tags}
            </div>

            <div class="relative mt-3 flex flex-wrap items-center justify-between gap-3">
              <div class="ml-auto flex items-baseline gap-2 whitespace-nowrap">
                <div class="text-[18px] font-black tracking-[.2px]">${money(p.price).replace(" ‚Ç¨","")}</div>
                <div class="text-[12px] font-bold text-muted2">‚Ç¨ / unit√©</div>
              </div>

              <div class="mt-2 flex w-full gap-2.5">
                <button class="flex-1 rounded-xl2 border border-white/10 bg-white/5 px-4 py-3 font-black tracking-[.2px] text-white/90 shadow-soft transition active:translate-y-[1px] active:scale-[.99] hover:border-white/15 hover:bg-white/10"
                        type="button" data-act="copyref" data-id="${p.id}">
                  üìã Copier la r√©f
                </button>

                <button class="flex-1 rounded-xl2 px-4 py-3 font-black tracking-[.2px] text-[#141414] shadow-accent transition active:translate-y-[1px] active:scale-[.99] hover:brightness-105"
                        style="background: linear-gradient(135deg,#FFD400,#FFB800);"
                        type="button" data-act="add" data-id="${p.id}">
                  ${qty>0 ? "‚úî Ajout√© ("+qty+")" : "+ Ajouter"}
                </button>
              </div>
            </div>
          </div>
        `;

        card.addEventListener("click", (e)=>{
          const btn = e.target.closest("[data-act]");
          if(!btn) return;
          e.preventDefault();
          e.stopPropagation();

          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");

          if(act === "copyref"){
            copyText(id).then(()=>{ toast("R√©f√©rence copi√©e"); haptic("light"); })
                        .catch(()=>{ toast("Copie impossible"); haptic("rigid"); });
          }
          if(act === "add"){
            const cur = Number(state.cart[id]||0);
            setQty(id, cur + 1);
            toast("Ajout√© au panier");
            haptic("light");
          }
        });

        el.list.appendChild(card);
      }
    }

    function renderCartBar(){
      const count = cartCount();
      const total = cartTotal();
      el.cartHint.textContent = count ? `${count} article(s) ‚Ä¢ Total indicatif ${money(total)}` : "Aucun article";
      el.cartCountBadge.textContent = String(count);

      if(count>0){
        el.cartCountBadge.style.background = "linear-gradient(135deg,#FFD400,#FFB800)";
        el.cartCountBadge.style.color = "#141414";
        el.cartCountBadge.style.borderColor = "rgba(255,212,0,.30)";
      }else{
        el.cartCountBadge.style.background = "rgba(255,212,0,.16)";
        el.cartCountBadge.style.color = "rgba(255,247,215,.95)";
        el.cartCountBadge.style.borderColor = "rgba(255,212,0,.22)";
      }
    }

    function openSheet(){
      el.mask.classList.remove("opacity-0","pointer-events-none");
      el.mask.classList.add("opacity-100");
      el.sheet.style.bottom = `calc(10px + var(--safe-bottom))`;
      renderCartSheet();
      haptic("light");
    }
    function closeSheet(){
      el.mask.classList.add("opacity-0","pointer-events-none");
      el.mask.classList.remove("opacity-100");
      el.sheet.style.bottom = `calc(-100% - 40px)`;
    }

    function renderCartSheet(){
      const items = cartItems();
      el.cartItems.innerHTML = "";

      el.cartEmpty.classList.toggle("hidden", items.length>0);

      for(const it of items){
        const line = Number(it.p.price||0) * it.qty;

        const row = document.createElement("div");
        row.className = "mb-2.5 flex items-start justify-between gap-3 rounded-xl2 border border-white/10 bg-black/20 p-3";
        row.innerHTML = `
          <div class="min-w-0">
            <div class="truncate text-[13.8px] font-black tracking-[.15px]">${escapeHTML(it.p.name)}</div>
            <div class="mt-1.5 flex flex-wrap gap-2 text-[12px] text-muted">
              <span class="rounded-full border border-white/10 bg-white/5 px-2 py-1">${escapeHTML(it.p.origin)}</span>
              <span class="rounded-full border border-white/10 bg-white/5 px-2 py-1">ID: ${escapeHTML(it.p.id)}</span>
              <span class="rounded-full border border-white/10 bg-white/5 px-2 py-1">PU: ${money(it.p.price)}</span>
            </div>
          </div>

          <div class="flex flex-none flex-col items-end gap-2.5">
            <div class="whitespace-nowrap text-[13.5px] font-black">${money(line)}</div>

            <div class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-2.5 py-2 select-none">
              <button type="button" data-act="dec" data-id="${it.p.id}"
                      class="grid h-7 w-7 place-items-center rounded-full border border-white/10 bg-black/20 font-black text-white/90 active:scale-[.98]">‚àí</button>
              <span class="w-7 text-center text-[13px] font-black text-white/90">${it.qty}</span>
              <button type="button" data-act="inc" data-id="${it.p.id}"
                      class="grid h-7 w-7 place-items-center rounded-full border border-white/10 bg-black/20 font-black text-white/90 active:scale-[.98]">+</button>
            </div>

            <div data-act="remove" data-id="${it.p.id}"
                 class="cursor-pointer select-none rounded-full border border-[rgba(255,77,77,.18)] bg-[rgba(255,77,77,.06)] px-2.5 py-1.5 text-[12px] text-[rgba(255,120,120,.95)]">
              Retirer
            </div>
          </div>
        `;

        row.addEventListener("click",(e)=>{
          const b = e.target.closest("[data-act]");
          if(!b) return;
          const act = b.getAttribute("data-act");
          const id = b.getAttribute("data-id");
          const cur = Number(state.cart[id]||0);

          if(act === "inc") setQty(id, cur+1);
          if(act === "dec") setQty(id, cur-1);
          if(act === "remove") setQty(id, 0);
          haptic("soft");
        });

        el.cartItems.appendChild(row);
      }

      el.total.textContent = money(cartTotal());
      applyModeUI();
      loadFormIntoUI();
    }

    function loadFormIntoUI(){
      el.mode.value = state.form.mode || "LIVRAISON";
      el.zone.value = state.form.zone || "59";
      el.fullname.value = state.form.fullname || "";
      el.phone.value = state.form.phone || "";
      el.address.value = state.form.address || "";
      el.note.value = state.form.note || "";
      applyModeUI();
    }
    function saveFormFromUI(){
      state.form = {
        mode: el.mode.value,
        zone: el.zone.value,
        fullname: el.fullname.value.trim(),
        phone: el.phone.value.trim(),
        address: el.address.value.trim(),
        note: el.note.value.trim()
      };
      saveJSON(FORM_KEY, state.form);
    }
    function applyModeUI(){
      const isDelivery = el.mode.value === "LIVRAISON";
      el.addrField.classList.toggle("hidden", !isDelivery);
    }

    function buildOrderText(){
      const items = cartItems();
      const total = cartTotal();
      const f = state.form;

      const lines = [];
      lines.push("üì¶ Ma Commande SLR BOOST");
      lines.push("");
      lines.push("üõí Produits :");
      for(const it of items){
        const line = Number(it.p.price||0) * it.qty;
        lines.push(`‚Ä¢ ${it.p.origin} ${it.p.name} ‚Äî ${it.p.id} √ó${it.qty} = ${money(line)}`);
      }
      lines.push("");
      lines.push(`üí∞ Total indicatif : ${money(total)}`);
      lines.push("‚ö†Ô∏è Le montant final peut varier (disponibilit√© / ajustements).");
      lines.push("");
      lines.push("üìç Livraison / Retrait :");
      lines.push(`üöö Mode : ${f.mode === "LIVRAISON" ? "Livraison" : "Sur place"}`);
      lines.push(`üìç Zone : ${f.zone || "-"}`);
      lines.push(`üë§ Nom : ${f.fullname || "-"}`);
      lines.push(`üìû T√©l√©phone : ${f.phone || "-"}`);
      if(f.mode === "LIVRAISON") lines.push(`üè† Adresse : ${f.address || "-"}`);
      if(f.note){
        lines.push("");
        lines.push("üí¨ Message :");
        lines.push(f.note);
      }
      try{
        const u = tg?.initDataUnsafe?.user;
        if(u){
          const who = [u.first_name, u.last_name].filter(Boolean).join(" ");
          const uname = u.username ? `@${u.username}` : "";
          lines.push("");
          lines.push(`üëÅÔ∏è Telegram : ${who}${uname ? " ("+uname+")" : ""}`);
        }
      }catch(_){}
      lines.push("");
      lines.push("‚úÖ Merci de confirmer la dispo + le prix final.");
      return lines.join("\n");
    }

    function validateBeforeOrder(){
      const items = cartItems();
      if(!items.length){ toast("Panier vide"); haptic("rigid"); return false; }
      const f = state.form;
      if(!f.fullname || f.fullname.length < 2){ toast("Ajoute ton nom/pr√©nom"); haptic("rigid"); return false; }
      if(!f.phone || f.phone.length < 6){ toast("Ajoute un t√©l√©phone valide"); haptic("rigid"); return false; }
      if(f.mode === "LIVRAISON" && (!f.address || f.address.length < 6)){
        toast("Ajoute une adresse (livraison)"); haptic("rigid"); return false;
      }
      return true;
    }

    function openChatWithPrefill(username, text){
      const url = `https://t.me/${encodeURIComponent(username)}?text=${encodeURIComponent(text)}`;
      try{
        if(tg?.openTelegramLink){ tg.openTelegramLink(url); return true; }
        if(tg?.openLink){ tg.openLink(url); return true; }
      }catch(_){}
      window.open(url, "_blank", "noopener,noreferrer");
      return true;
    }

    async function handleOrder(){
      saveFormFromUI();
      if(!validateBeforeOrder()) return;

      const msg = buildOrderText();

      try{ await copyText(msg); }catch(_){}
      toast("R√©cap copi√© ‚úÖ");

      openChatWithPrefill(CONTACT_USERNAME, msg);
      haptic("light");
    }

    function renderAll(){
      buildChips();
      renderList();
      renderCartBar();
      const opened = el.mask.classList.contains("opacity-100") && !el.mask.classList.contains("pointer-events-none");
      if(opened) renderCartSheet();
    }

    // EVENTS
    el.q.addEventListener("input", ()=>{ state.q = el.q.value || ""; renderAll(); });

    el.cartPreview.addEventListener("click", openSheet);
    el.btnCartTop.addEventListener("click", openSheet);

    el.sheetClose.addEventListener("click", closeSheet);
    el.mask.addEventListener("click", closeSheet);

    el.mode.addEventListener("change", ()=>{ applyModeUI(); saveFormFromUI(); });
    ["zone","fullname","phone","address","note"].forEach(id=>{
      el[id].addEventListener("input", saveFormFromUI);
      el[id].addEventListener("change", saveFormFromUI);
    });

    el.clear.addEventListener("click", ()=>{
      state.cart = {};
      saveJSON(CART_KEY, state.cart);
      renderAll();
      toast("Panier vid√©");
      haptic("soft");
    });

    el.copy.addEventListener("click", async ()=>{
      saveFormFromUI();
      const msg = buildOrderText();
      try{ await copyText(msg); toast("R√©cap copi√©"); haptic("light"); }
      catch(_){ toast("Copie impossible"); haptic("rigid"); }
    });

    el.order.addEventListener("click", handleOrder);

    // Back button (sheet close first)
    try{
      if(tg?.BackButton){
        tg.BackButton.show();
        tg.BackButton.onClick(()=>{
          const opened = el.mask.classList.contains("opacity-100") && !el.mask.classList.contains("pointer-events-none");
          if(opened) closeSheet();
          else tg.close?.();
        });
      }
    }catch(_){}

    // INIT
    function init(){
      // prefill UI from storage
      el.mode.value = state.form.mode || "LIVRAISON";
      el.zone.value = state.form.zone || "59";
      el.fullname.value = state.form.fullname || "";
      el.phone.value = state.form.phone || "";
      el.address.value = state.form.address || "";
      el.note.value = state.form.note || "";
      applyModeUI();

      renderAll();
    }
    init();
  </script>
</body>
</html>
